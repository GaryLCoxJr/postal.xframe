/*
 postal.xframe
 Copyright (C) 2012 - Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT & GPL v2.0
 Version 0.1.0
 */
(function(e,t){typeof module=="object"&&module.exports?module.exports=t(require("underscore"),require("postal.federation")):typeof define=="function"&&define.amd?define(["underscore","postal.federation"],function(n,r){return t(n,r,e)}):e.postal=t(e._,e.postal,e)})(this,function(e,t,n,r){var i="xframe",s={autoReciprocate:!0,allowedOrigins:[window.location.origin],enabled:!0,originUrl:window.location.origin},o=s,u=t.fedx.transports.xframe={config:function(t){return t&&(o=e.defaults(t,s)),o},clientOptionsFromEvent:function(t){var n=this,r=t.data,s={id:r.instanceId,type:i,send:function(r){t.source.postMessage(e.defaults({envelope:r},n.getXframeWrapper("message")),o.originUrl||"*")}};return o.autoReciprocate&&(s.postSetup=function(){t.source.postMessage(n.getXframeWrapper("ready"),o.originUrl||"*")}),s},getTargets:function(){var t=e.map(document.getElementsByTagName("iframe"),function(e){return e.contentWindow});return window.parent&&window.parent!==window&&t.push(window.parent),t},getXframeWrapper:function(e){return{postal:!0,type:e,instanceId:t.instanceId}},onPostMessage:function(e){console.log(e.data);if(this.shouldProcess(e)){var n=e.data;n.type==="ready"?t.fedx.addClient(this.clientOptionsFromEvent(e)):t.fedx.onFederatedMsg(n.envelope,n.instanceId)}},shouldProcess:function(t){var n=!!o.allowedOrigins.length;return o.enabled&&(n&&e.contains(o.allowedOrigins,t.origin)||!n)&&t.data.postal},signalReady:function(t){var n;t?n=e.isArray(t)?t:[t]:n=this.getTargets(),e.each(n,function(e){e.postMessage(this.getXframeWrapper("ready"),o.originUrl||"*")},this)}};return e.bindAll(u),window.addEventListener("message",u.onPostMessage,!1),t})