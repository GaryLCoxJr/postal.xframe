/*
 postal.xframe
 Copyright (C) 2012 - Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT & GPL v2.0
 Version 0.2.2
 */
(function(n,e){"object"==typeof module&&module.exports?module.exports=e(require("underscore"),require("postal.federation")):"function"==typeof define&&define.amd?define(["underscore","postal.federation"],function(t,r){return e(t,r,n)}):n.postal=e(n._,n.postal,n)})(this,function(n,e){window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.host);var t=/MSIE [8,9]/.test(navigator.userAgent),r="xframe",i=function(){},o={allowedOrigins:[window.location.origin],enabled:!0,defaultOriginUrl:"*"},a=o,s=e.fedx.FederationClient.extend({transportName:r,shouldProcess:function(){var e=!!a.allowedOrigins.length;return a.enabled&&("*"===this.options.origin||e&&n.contains(a.allowedOrigins,this.options.origin)||!e)},send:function(n){this.shouldProcess()&&this.target.postMessage(e.fedx.transports[r].wrapForTransport(n),this.options.origin)}}),u=e.fedx.transports[r]={eagerSerialize:t,XFrameClient:s,configure:function(e){return e&&(a=n.defaults(e,o)),a},getTargets:function(){var e=n.map(document.getElementsByTagName("iframe"),function(n){var e=document.createElement("a");return e.href=n.src,{target:n.contentWindow,origin:e.protocol+"//"+e.host||a.defaultOriginUrl}});return window.parent&&window.parent!==window&&e.push({target:window.parent,origin:"*"}),e},remotes:[],wrapForTransport:t?function(n){return JSON.stringify({postal:!0,packingSlip:n})}:function(n){return{postal:!0,packingSlip:n}},unwrapFromTransport:t?function(n){try{return JSON.parse(n)}catch(e){return{}}}:function(n){return n},routeMessage:function(e){var t=this.unwrapFromTransport(e.data);if(t.postal){var r=n.find(this.remotes,function(n){return n.target===e.source});r||(r=new s(e.source,{origin:e.origin},t.packingSlip.instanceId),this.remotes.push(r)),r.onMessage(t.packingSlip)}},sendMessage:function(e){n.each(this.remotes,function(n){n.sendMessage(e)})},signalReady:function(e,t){e=n.isArray(e)?e:[e],e=e.length?e:this.getTargets(),t=t||i,n.each(e,function(e){if(e.target){e.origin=e.origin||a.defaultOriginUrl;var r=n.find(this.remotes,function(n){return n.target===e.target});r||(r=new s(e.target,{origin:e.origin}),this.remotes.push(r)),r.sendPing(t)}},this)},addEventListerner:function(n,e,t,r){"addEventListener"in n?n.addEventListener(e,t,r):n.attachEvent("on"+e,t)}};return n.bindAll(u),u.addEventListerner(window,"message",u.routeMessage,!1),e});