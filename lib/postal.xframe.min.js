/*
 postal.xframe
 Copyright (C) 2012 - Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT & GPL v2.0
 Version 0.2.1
 */
(function(e,t){typeof module=="object"&&module.exports?module.exports=t(require("underscore"),require("postal.federation")):typeof define=="function"&&define.amd?define(["underscore","postal.federation"],function(n,r){return t(n,r,e)}):e.postal=t(e._,e.postal,e)})(this,function(e,t,n,r){window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.host);var i=/MSIE [8,9]/.test(navigator.userAgent),s="xframe",o=function(){},u={allowedOrigins:[window.location.origin],enabled:!0,defaultOriginUrl:"*"},a=u,f=t.fedx.FederationClient.extend({transportName:s,shouldProcess:function(){var t=!!a.allowedOrigins.length;return a.enabled&&(this.options.origin==="*"||t&&e.contains(a.allowedOrigins,this.options.origin)||!t)},send:function(e){this.shouldProcess()&&this.target.postMessage(t.fedx.transports[s].wrapForTransport(e),this.options.origin)}}),l=t.fedx.transports[s]={eagerSerialize:i,XFrameClient:f,configure:function(t){return t&&(a=e.defaults(t,u)),a},getTargets:function(){var t=e.map(document.getElementsByTagName("iframe"),function(e){var t=document.createElement("a");return t.href=e.src,{target:e.contentWindow,origin:t.protocol+"//"+t.host||a.defaultOriginUrl}});return window.parent&&window.parent!==window&&t.push({target:window.parent,origin:"*"}),t},remotes:[],wrapForTransport:i?function(e){return JSON.stringify({postal:!0,packingSlip:e})}:function(e){return{postal:!0,packingSlip:e}},unwrapFromTransport:i?function(e){try{return JSON.parse(e)}catch(t){return{}}}:function(e){return e},routeMessage:function(t){var n=this.unwrapFromTransport(t.data);if(n.postal){var r=e.find(this.remotes,function(e){return e.target===t.source});r||(r=new f(t.source,{origin:t.origin},n.packingSlip.instanceId),this.remotes.push(r)),r.onMessage(n.packingSlip)}},sendMessage:function(t){e.each(this.remotes,function(e){e.sendMessage(t)})},signalReady:function(t,n){t=e.isArray(t)?t:[t],t=t.length?t:this.getTargets(),n=n||o,e.each(t,function(t){if(t.target){t.origin=t.origin||a.defaultOriginUrl;var r=e.find(this.remotes,function(e){return e.target===t.target});r||(r=new f(t.target,{origin:t.origin}),this.remotes.push(r)),r.sendPing(n)}},this)}};return e.bindAll(l),window.addEventListener("message",l.routeMessage,!1),t})