/*
 postal.xframe
 Copyright (C) 2012 - Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT & GPL v2.0
 Version 0.2.3
 */
(function(t,n){"object"==typeof module&&module.exports?module.exports=n(require("underscore"),require("postal.federation")):"function"==typeof define&&define.amd?define(["underscore","postal.federation"],function(e,r){return n(e,r,t)}):t.postal=n(t._,t.postal,t)})(this,function(t,n){window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.host);var e=/MSIE [8,9]/.test(navigator.userAgent),r=function(n,e){var r=t.find(this.remotes,function(t){return t.instanceId===e});return r&&n.push(r),n},i=function(n,e){var r=t.find(this.remotes,function(t){return t.target===e});return r&&n.push(r),n},o=function(t){t.disconnect()},s="xframe",a=function(){},u={allowedOrigins:[window.location.origin],enabled:!0,defaultOriginUrl:"*"},c=u,d=n.fedx.FederationClient.extend({transportName:"xframe",shouldProcess:function(){var n=!!c.allowedOrigins.length;return c.enabled&&("*"===this.options.origin||n&&t.contains(c.allowedOrigins,this.options.origin)||!n)},send:function(t){this.shouldProcess()&&this.target.postMessage(n.fedx.transports[s].wrapForTransport(t),this.options.origin)}}),g=n.fedx.transports[s]={eagerSerialize:e,XFrameClient:d,configure:function(n){return n&&(c=t.defaults(n,u)),c},getTargets:function(){var n=t.map(document.getElementsByTagName("iframe"),function(t){var n=document.createElement("a");return n.href=t.src,{target:t.contentWindow,origin:n.protocol+"//"+n.host||c.defaultOriginUrl}});return window.parent&&window.parent!==window&&n.push({target:window.parent,origin:"*"}),n},remotes:[],wrapForTransport:e?function(t){return JSON.stringify({postal:!0,packingSlip:t})}:function(t){return{postal:!0,packingSlip:t}},unwrapFromTransport:e?function(t){try{return JSON.parse(t)}catch(n){return{}}}:function(t){return t},routeMessage:function(n){var e=this.unwrapFromTransport(n.data);if(e.postal){var r=t.find(this.remotes,function(t){return t.target===n.source});r||(r=new d(n.source,{origin:n.origin},e.packingSlip.instanceId),this.remotes.push(r)),r.onMessage(e.packingSlip)}},sendMessage:function(n){t.each(this.remotes,function(t){t.sendMessage(n)})},disconnect:function(n){n=n||{};var e=n.instanceId?t.reduce(t.isArray(n.instanceId)?n.instanceId:[n.instanceId],r,[],this):n.target?t.reduce(t.isArray(n.target)?n.target:[n.target],i,[],this):this.remotes;n.doNotNotify||t.each(e,o,this),this.remotes=t.without.apply(null,[this.remotes].concat(e))},signalReady:function(n,e){n=t.isArray(n)?n:[n],n=n.length?n:this.getTargets(),e=e||a,t.each(n,function(n){if(n.target){n.origin=n.origin||c.defaultOriginUrl;var r=t.find(this.remotes,function(t){return t.target===n.target});r||(r=new d(n.target,{origin:n.origin}),this.remotes.push(r)),r.sendPing(e)}},this)},addEventListener:function(t,n,e,r){"addEventListener"in t?t.addEventListener(n,e,r):t.attachEvent("on"+n,e)}};return t.bindAll(g),g.addEventListener(window,"message",g.routeMessage,!1),n});