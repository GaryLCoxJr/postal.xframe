/*
 postal.xframe
 Copyright (C) 2012 - Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT & GPL v2.0
 Version 0.1.0
 */
(function(e,t){typeof module=="object"&&module.exports?module.exports=t(require("underscore"),require("postal.federation")):typeof define=="function"&&define.amd?define(["underscore","postal.federation"],function(n,r){return t(n,r,e)}):e.postal=t(e._,e.postal,e)})(this,function(e,t,n,r){var i="xframe",s={autoReciprocate:!0,allowedOrigins:[window.location.origin],enabled:!0,originUrl:window.location.origin},o=s,u=function(e,t,n){this.source=e,this.instanceId=t,this.autoReciprocate=n};u.prototype.send=function(e){this.source.postMessage(t.fedx.transports.xframe.getWrapper("message",e),o.originUrl||"*")},u.prototype.reciprocate=function(){this.source.postMessage(t.fedx.transports.xframe.getWrapper("ready"),o.originUrl||"*")},u.prototype.attachToClient=function(e){e[i]||(e[i]=this,this.autoReciprocate&&this.reciprocate())};var a=t.fedx.transports.xframe={XFrameClient:u,config:function(t){return t&&(o=e.defaults(t,s)),o},getTargets:function(){var t=e.map(document.getElementsByTagName("iframe"),function(e){return e.contentWindow});return window.parent&&window.parent!==window&&t.push(window.parent),t},getWrapper:function(e,n){switch(e){case"ready":return{postal:!0,type:e,instanceId:t.instanceId};default:return{postal:!0,type:e,instanceId:t.instanceId,envelope:n}}},onPostMessage:function(e){console.log(e.data);if(this.shouldProcess(e)){var n=e.data;n.type==="ready"?t.fedx.addClient(new u(e.source,e.data.instanceId,o.autoReciprocate),i):t.fedx.onFederatedMsg(n.envelope,n.instanceId)}},shouldProcess:function(t){var n=!!o.allowedOrigins.length;return o.enabled&&(n&&e.contains(o.allowedOrigins,t.origin)||!n)&&t.data.postal},signalReady:function(t){var n;t?n=e.isArray(t)?t:[t]:n=this.getTargets(),e.each(n,function(e){e.postMessage(this.getWrapper("ready"),o.originUrl||"*")},this)}};return e.bindAll(a),window.addEventListener("message",a.onPostMessage,!1),t})