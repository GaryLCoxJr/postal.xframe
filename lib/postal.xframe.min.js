/*
 postal.xframe
 Copyright (C) 2012 - Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT & GPL v2.0
 Version 0.2.4
 */
(function(e,t){"object"==typeof module&&module.exports?module.exports=t(require("underscore"),require("postal.federation")):"function"==typeof define&&define.amd?define(["underscore","postal.federation"],function(n,r){return t(n,r,e)}):e.postal=t(e._,e.postal,e)})(this,function(e,t){var n=location.origin||location.protocol+"//"+location.host,r=/MSIE [8,9]/.test(navigator.userAgent),i=function(t,n){var r=e.find(this.remotes,function(e){return e.instanceId===n});return r&&t.push(r),t},o=function(t,n){var r=e.find(this.remotes,function(e){return e.target===n});return r&&t.push(r),t},s=function(e){e.disconnect()},a="undefined"==typeof window&&postMessage&&location,u=[],c="xframe",d=function(){},g={allowedOrigins:[n],enabled:!0,defaultOriginUrl:"*"},f=g,p=t.fedx.FederationClient.extend({transportName:"xframe",shouldProcess:function(){var t=!!f.allowedOrigins.length;return f.enabled&&("*"===this.options.origin||t&&e.contains(f.allowedOrigins,this.options.origin)||!t||this.options.isWorker&&e.contains(u,this.target)||a)},send:function(e){var n,r;this.shouldProcess()&&(r=a?null:this.target,n=[t.fedx.transports[c].wrapForTransport(e)],this.options.isWorker||a||n.push(this.options.origin),this.target.postMessage.apply(r,n))}},{getInstance:function(e,t,n){var r=new p(e,{origin:t,isWorker:"undefined"!=typeof Worker&&e instanceof Worker},n);return r.options.isWorker&&l.listenToWorker(r.target),r}}),l=t.fedx.transports[c]={eagerSerialize:r,XFrameClient:p,configure:function(t){return t&&(f=e.defaults(t,g)),f},getTargets:a?function(){return[{target:{postMessage:postMessage}}]}:function(){var t=e.map(document.getElementsByTagName("iframe"),function(e){var t=document.createElement("a");return t.href=e.src,{target:e.contentWindow,origin:t.protocol+"//"+t.host||f.defaultOriginUrl}});return window.parent&&window.parent!==window&&t.push({target:window.parent,origin:"*"}),t.concat(u)},remotes:[],wrapForTransport:r?function(e){return JSON.stringify({postal:!0,packingSlip:e})}:function(e){return{postal:!0,packingSlip:e}},unwrapFromTransport:r?function(e){try{return JSON.parse(e)}catch(t){return{}}}:function(e){return e},routeMessage:function(n){var r=n.source||n.currentTarget,i=this.unwrapFromTransport(n.data);if(i.postal){"worker"===t.instanceId()&&console.log("parsed: "+JSON.stringify(i));var o=e.find(this.remotes,function(e){return e.target===r});o||(o=p.getInstance(r,n.origin,i.packingSlip.instanceId),this.remotes.push(o)),o.onMessage(i.packingSlip)}},sendMessage:function(t){e.each(this.remotes,function(e){e.sendMessage(t)})},disconnect:function(t){t=t||{};var n=t.instanceId?e.reduce(e.isArray(t.instanceId)?t.instanceId:[t.instanceId],i,[],this):t.target?e.reduce(e.isArray(t.target)?t.target:[t.target],o,[],this):this.remotes;t.doNotNotify||e.each(n,s,this),this.remotes=e.without.apply(null,[this.remotes].concat(n))},signalReady:function(t,n){t=e.isArray(t)?t:[t],t=t.length?t:this.getTargets(),n=n||d,e.each(t,function(t){if(t.target){t.origin=t.origin||f.defaultOriginUrl;var r=e.find(this.remotes,function(e){return e.target===t.target});r||(r=p.getInstance(t.target,t.origin),this.remotes.push(r)),r.sendPing(n)}},this)},addEventListener:a?function(){addEventListener("message",l.routeMessage)}:function(e,t,n,r){"undefined"!=typeof window&&("addEventListener"in e?e.addEventListener(t,n,r):e.attachEvent("on"+t,n))},listenToWorker:function(t){e.include(u,t)||(t.addEventListener("message",l.routeMessage),u.push(t))},stopListeningToWorker:function(t){if(t)t.removeEventListener("message",l.routeMessage),u=e.without(u,t);else for(;u.length;)u.pop().removeEventListener("message",l.routeMessage)}};return e.bindAll(l),l.addEventListener(this,"message",l.routeMessage,!1),t});