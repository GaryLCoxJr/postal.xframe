/*
 postal.xframe
 Copyright (C) 2012 - Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT & GPL v2.0
 Version 0.2.3
 */
(function(t,n){"object"==typeof module&&module.exports?module.exports=n(require("underscore"),require("postal.federation")):"function"==typeof define&&define.amd?define(["underscore","postal.federation"],function(e,r){return n(e,r,t)}):t.postal=n(t._,t.postal,t)})(this,function(t,n){var e=location.origin||location.protocol+"//"+location.host,r=/MSIE [8,9]/.test(navigator.userAgent),i=function(n,e){var r=t.find(this.remotes,function(t){return t.instanceId===e});return r&&n.push(r),n},o=function(n,e){var r=t.find(this.remotes,function(t){return t.target===e});return r&&n.push(r),n},s=function(t){t.disconnect()},a="xframe",u=function(){},c={allowedOrigins:[e],enabled:!0,defaultOriginUrl:"*"},d=c,g=n.fedx.FederationClient.extend({transportName:"xframe",shouldProcess:function(){var n=!!d.allowedOrigins.length;return d.enabled&&("*"===this.options.origin||n&&t.contains(d.allowedOrigins,this.options.origin)||!n)},send:function(t){this.shouldProcess()&&this.target.postMessage(n.fedx.transports[a].wrapForTransport(t),this.options.origin)}}),f=n.fedx.transports[a]={eagerSerialize:r,XFrameClient:g,configure:function(n){return n&&(d=t.defaults(n,c)),d},getTargets:function(){var n=t.map(document.getElementsByTagName("iframe"),function(t){var n=document.createElement("a");return n.href=t.src,{target:t.contentWindow,origin:n.protocol+"//"+n.host||d.defaultOriginUrl}});return window.parent&&window.parent!==window&&n.push({target:window.parent,origin:"*"}),n},remotes:[],wrapForTransport:r?function(t){return JSON.stringify({postal:!0,packingSlip:t})}:function(t){return{postal:!0,packingSlip:t}},unwrapFromTransport:r?function(t){try{return JSON.parse(t)}catch(n){return{}}}:function(t){return t},routeMessage:function(n){var e=this.unwrapFromTransport(n.data);if(e.postal){var r=t.find(this.remotes,function(t){return t.target===n.source});r||(r=new g(n.source,{origin:n.origin},e.packingSlip.instanceId),this.remotes.push(r)),r.onMessage(e.packingSlip)}},sendMessage:function(n){t.each(this.remotes,function(t){t.sendMessage(n)})},disconnect:function(n){n=n||{};var e=n.instanceId?t.reduce(t.isArray(n.instanceId)?n.instanceId:[n.instanceId],i,[],this):n.target?t.reduce(t.isArray(n.target)?n.target:[n.target],o,[],this):this.remotes;n.doNotNotify||t.each(e,s,this),this.remotes=t.without.apply(null,[this.remotes].concat(e))},signalReady:function(n,e){n=t.isArray(n)?n:[n],n=n.length?n:this.getTargets(),e=e||u,t.each(n,function(n){if(n.target){n.origin=n.origin||d.defaultOriginUrl;var r=t.find(this.remotes,function(t){return t.target===n.target});r||(r=new g(n.target,{origin:n.origin}),this.remotes.push(r)),r.sendPing(e)}},this)},addEventListener:function(t,n,e,r){"addEventListener"in t?t.addEventListener(n,e,r):t.attachEvent("on"+n,e)}};return t.bindAll(f),f.addEventListener(window,"message",f.routeMessage,!1),n});