/*
 postal.xframe
 Copyright (C) 2012 - Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT & GPL v2.0
 Version 0.2.1
 */
(function(n,t){"object"==typeof module&&module.exports?module.exports=t(require("underscore"),require("postal.federation")):"function"==typeof define&&define.amd?define(["underscore","postal.federation"],function(e,i){return t(e,i,n)}):n.postal=t(n._,n.postal,n)})(this,function(n,t){window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.host);var e=/MSIE [8,9]/.test(navigator.userAgent),i="xframe",r=function(){},o={allowedOrigins:[window.location.origin],enabled:!0,defaultOriginUrl:"*"},s=o,a=t.fedx.FederationClient.extend({transportName:i,shouldProcess:function(){var t=!!s.allowedOrigins.length;return s.enabled&&("*"===this.options.origin||t&&n.contains(s.allowedOrigins,this.options.origin)||!t)},send:function(n){this.shouldProcess()&&this.target.postMessage(t.fedx.transports[i].wrapForTransport(n),this.options.origin)},disconnect:function(n){this.send(n)}}),u=t.fedx.transports[i]={eagerSerialize:e,XFrameClient:a,configure:function(t){return t&&(s=n.defaults(t,o)),s},getTargets:function(){var t=n.map(document.getElementsByTagName("iframe"),function(n){var t=document.createElement("a");return t.href=n.src,{target:n.contentWindow,origin:t.protocol+"//"+t.host||s.defaultOriginUrl}});return window.parent&&window.parent!==window&&t.push({target:window.parent,origin:"*"}),t},remotes:[],wrapForTransport:e?function(n){return JSON.stringify({postal:!0,packingSlip:n})}:function(n){return{postal:!0,packingSlip:n}},unwrapFromTransport:e?function(n){try{return JSON.parse(n)}catch(t){return{}}}:function(n){return n},routeMessage:function(t){var e=this.unwrapFromTransport(t.data);if(e.postal){var i=n.find(this.remotes,function(n){return n.target===t.source});if("federation.disconnect"===e.packingSlip.type)return this.remotes=n.without(this.remotes,i),undefined;i||(i=new a(t.source,{origin:t.origin},e.packingSlip.instanceId),this.remotes.push(i)),i.onMessage(e.packingSlip)}},sendMessage:function(t){n.each(this.remotes,function(n){n.sendMessage(t)})},disconnect:function(t,e,i){t=n.isArray(t)?t:[t],t=t.length?t:this.getTargets(),i=i||r,n.each(t,function(t){if(t.target){t.origin=t.origin||s.defaultOriginUrl;var r=n.find(this.remotes,function(n){return n.target===t.target});r&&r.disconnect(e,i)}},this),this.remotes=[]},signalReady:function(t,e){t=n.isArray(t)?t:[t],t=t.length?t:this.getTargets(),e=e||r,n.each(t,function(t){if(t.target){t.origin=t.origin||s.defaultOriginUrl;var i=n.find(this.remotes,function(n){return n.target===t.target});i||(i=new a(t.target,{origin:t.origin}),this.remotes.push(i)),i.sendPing(e)}},this)}};return n.bindAll(u),window.addEventListener("message",u.routeMessage,!1),t});