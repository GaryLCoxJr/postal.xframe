(function(t,n){"object"==typeof module&&module.exports?module.exports=function(t,e,i){return n(t,e,i)}:"function"==typeof define&&define.amd?define(["underscore","postal","riveter"],function(e,i,r){return n(e,i,r,t)}):t.postal=n(t._,t.postal,t.riveter,t)})(this,function(t,n,e,i,r){n.utils.createUUID||(n.utils.createUUID=function(){for(var t=[],n="0123456789abcdef",e=0;36>e;e++)t[e]=n.substr(Math.floor(16*Math.random()),1);return t[14]="4",t[19]=n.substr(8|3&t[19],1),t[8]=t[13]=t[18]=t[23]="-",t.join("")}),n.instanceId||(n.instanceId=function(){var t,e;return function(i){return i&&(e=t,t=i,n.publish({channel:n.configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",data:{oldId:e,newId:t}})),t}}());var o=function(){},s=!1,a=[],c=[],d=[],u={enabled:!0,filterMode:"whitelist",filterDirection:"both"},p=u,l={ping:function(){return{type:"federation.ping",instanceId:n.instanceId(),timeStamp:new Date,ticket:n.utils.createUUID()}},pong:function(t){return{type:"federation.pong",instanceId:n.instanceId(),timeStamp:new Date,pingData:{instanceId:t.instanceId,timeStamp:t.timeStamp,ticket:t.ticket}}},message:function(t){return{type:"federation.message",instanceId:n.instanceId(),timeStamp:new Date,envelope:t}},disconnect:function(){return{type:"federation.disconnect",instanceId:n.instanceId(),timeStamp:new Date}},bundle:function(t){return{type:"federation.bundle",instanceId:n.instanceId(),timeStamp:new Date,packingSlips:t}}},f={"federation.ping":function(t){t.source.instanceId=t.packingSlip.instanceId,t.source.handshakeComplete?t.source.sendPong(t.packingSlip):t.source.sendBundle([n.fedx.getPackingSlip("pong",t.packingSlip),n.fedx.getPackingSlip("ping")])},"federation.pong":function(e){e.source.handshakeComplete=!0,e.source.instanceId=e.packingSlip.instanceId,e.source.pings[e.packingSlip.pingData.ticket]&&(e.source.pings[e.packingSlip.pingData.ticket].callback({ticket:e.packingSlip.pingData.ticket,instanceId:e.packingSlip.instanceId,source:e.source}),e.source.pings[e.packingSlip.pingData.ticket]=r),t.contains(n.fedx.clients,e.packingSlip.instanceId)||n.fedx.clients.push(e.packingSlip.instanceId),n.publish({channel:"postal.federation",topic:"client.federated",data:{remoteId:e.source.instanceId,localId:n.instanceId(),transport:e.transport}})},"federation.disconnect":function(e){n.fedx.clients=t.without(n.fedx.clients,e.source.instanceId),n.fedx.disconnect({transport:e.source.transportName,instanceId:e.source.instanceId,doNotNotify:!0})},"federation.message":function(t){var e=t.packingSlip.envelope;g(e.channel,e.topic,"in")&&(e.lastSender=t.packingSlip.instanceId,n.publish(e))},"federation.bundle":function(e){t.each(e.packingSlip.packingSlips,function(i){n.fedx.onFederatedMsg(t.extend({},e,{packingSlip:i}))})}},g=function(e,i,r){var o=Object.prototype.hasOwnProperty.call(n.fedx.filters[r],e),s=o&&t.any(n.fedx.filters[r][e],function(t){return n.configuration.resolver.compare(t,i)}),a="blacklist"===p.filterMode;return p.enabled&&(a&&(!o||o&&!s)||!a&&o&&s)},h=function(t,n,e){this.target=t,this.options=n||{},this.pings={},this.instanceId=e,this.handshakeComplete=!1};return h.prototype.sendPing=function(t){var e=n.fedx.getPackingSlip("ping");this.pings[e.ticket]={ticket:e.ticket,callback:t||o},this.send(e)},h.prototype.sendPong=function(t){this.send(n.fedx.getPackingSlip("pong",t))},h.prototype.sendBundle=function(t){this.send(n.fedx.getPackingSlip("bundle",t))},h.prototype.sendMessage=function(e){if(this.handshakeComplete){e.originId=e.originId||n.instanceId();var i=t.clone(e);!this.instanceId||this.instanceId===i.lastSender||i.knownIds&&i.knownIds.length&&(!i.knownIds||t.include(i.knownIds,this.instanceId))||(i.knownIds=(i.knownIds||[]).concat(t.without(n.fedx.clients,this.instanceId)),this.send(n.fedx.getPackingSlip("message",i)))}},h.prototype.disconnect=function(){this.send(n.fedx.getPackingSlip("disconnect"))},h.prototype.onMessage=function(t){this.shouldProcess()&&n.fedx.onFederatedMsg({transport:this.transportName,packingSlip:t,source:this})},h.prototype.shouldProcess=function(){return!0},h.prototype.send=function(){throw Error("An object deriving from FederationClient must provide an implementation for 'send'.")},e(h),n.fedx=t.extend({FederationClient:h,clients:[],transports:{},filters:{"in":{},out:{}},addFilter:function(n){n=t.isArray(n)?n:[n],t.each(n,function(n){n.direction=n.direction||p.filterDirection,t.each("both"===n.direction?["in","out"]:[n.direction],function(e){this.filters[e][n.channel]?t.include(this.filters[e][n.channel],n.topic)||this.filters[e][n.channel].push(n.topic):this.filters[e][n.channel]=[n.topic]},this)},this)},removeFilter:function(n){n=t.isArray(n)?n:[n],t.each(n,function(n){n.direction=n.direction||p.filterDirection,t.each("both"===n.direction?["in","out"]:[n.direction],function(e){this.filters[e][n.channel]&&t.include(this.filters[e][n.channel],n.topic)&&(this.filters[e][n.channel]=t.without(this.filters[e][n.channel],n.topic))},this)},this)},canSendRemote:function(t,n){return g(t,n,"out")},configure:function(n){if(n&&n.filterMode&&"blacklist"!==n.filterMode&&"whitelist"!==n.filterMode)throw Error("postal.fedx filterMode must be 'blacklist' or 'whitelist'.");return n&&(p=t.defaults(n,u)),p},getPackingSlip:function(t){return Object.prototype.hasOwnProperty.call(l,t)?l[t].apply(this,Array.prototype.slice.call(arguments,1)):r},onFederatedMsg:function(t){if(!s)return a.push(t),r;if(!Object.prototype.hasOwnProperty.call(f,t.packingSlip.type))throw Error("postal.federation does not have a message handler for '"+t.packingSlip.type+"'.");f[t.packingSlip.type](t)},sendMessage:function(n){return s?(t.each(this.transports,function(t){t.sendMessage(n)}),r):(c.push(arguments),r)},disconnect:function(n){n=n||{};var e=this.transports;n.transport&&(e={},e[n.transport]=this.transports[n.transport]),t.each(e,function(t){t.disconnect({targets:n.targets,instanceId:n.instanceId,doNotNotify:!!n.doNotNotify})},this)},_getTransports:function(){return t.reduce(this.transports,function(t,n,e){return t[e]=!0,t},{})},signalReady:function(n,e){if(!s)return d.push(arguments),r;var i=this._getTransports();switch(arguments.length){case 1:"function"==typeof n&&(e=n);break;case 2:"string"==typeof n?(i={},i[n]=this.transports[n]):i=n}t.each(i,function(t,n){t="boolean"==typeof t?[]:t,this.transports[n].signalReady(t,e)},this)}},n.fedx),n.addWireTap(function(t,e){n.fedx.canSendRemote(e.channel,e.topic)&&n.fedx.sendMessage(e)}),n.subscribe({channel:n.configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",callback:function(){for(s=!0;d.length;)(function(t){n.fedx.signalReady.apply(this,t)})(d.shift());for(;c.length;)(function(t){n.fedx.send.apply(this,t)})(c.shift());for(;a.length;)(function(t){n.fedx.onFederatedMsg.call(this,t)})(a.shift())}}),n.instanceId()!==r&&(s=!0),n});