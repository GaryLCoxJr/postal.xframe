/*
 postal.federation
 Copyright (C) 2012 - Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT & GPL v2.0
 Version 0.1.0
 */
(function(e,t){typeof module=="object"&&module.exports?module.exports=function(e,n,r){return t(e,n,r)}:typeof define=="function"&&define.amd?define(["underscore","postal","riveter"],function(n,r,i){return t(n,r,i,e)}):e.postal=t(e._,e.postal,e.riveter,e)})(this,function(e,t,n,r,i){t.utils.createUUID||(t.utils.createUUID=function(){var e=[],t="0123456789abcdef";for(var n=0;n<36;n++)e[n]=t.substr(Math.floor(Math.random()*16),1);return e[14]="4",e[19]=t.substr(e[19]&3|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")}),t.instanceId||(t.instanceId=function(){var e,n;return function(r){return r&&(n=e,e=r,t.publish({channel:t.configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",data:{oldId:n,newId:e}})),e}}());var s=!1,o=[],u=[],a=[],f={enabled:!0,filterMode:"whitelist",filterDirection:"both"},l=f,c={ping:function(){return{type:"federation.ping",instanceId:t.instanceId(),timeStamp:new Date,ticket:t.utils.createUUID()}},pong:function(e){return{type:"federation.pong",instanceId:t.instanceId(),timeStamp:new Date,pingData:{instanceId:e.instanceId,timeStamp:e.timeStamp,ticket:e.ticket}}},message:function(e){return{type:"federation.message",instanceId:t.instanceId(),timeStamp:new Date,envelope:e}},bundle:function(e){return{type:"federation.bundle",instanceId:t.instanceId(),timeStamp:new Date,packingSlips:e}}},h={"federation.ping":function(e,n){e.source.instanceId=e.packingSlip.instanceId,e.source.sendPong(e.packingSlip),e.source.handshakeComplete||e.source.sendBundle([t.fedx.getPackingSlip("pong",e.packingSlip),t.fedx.getPackingSlip("ping")])},"federation.pong":function(e){e.source.handshakeComplete=!0,e.source.instanceId=e.packingSlip.instanceId,e.source.pings[e.packingSlip.pingData.ticket]&&(e.source.pings[e.packingSlip.pingData.ticket].callback({ticket:e.packingSlip.pingData.ticket,instanceId:e.packingSlip.instanceId,source:e.source}),e.source.pings[e.packingSlip.pingData.ticket]=i),t.publish({channel:"postal.federation",topic:"client.federated",data:{remoteId:e.source.instanceId,localId:t.instanceId(),transport:e.transport}})},"federation.message":function(e){var n=e.packingSlip.envelope;p(n.channel,n.topic,"in")&&(n.lastSender=e.packingSlip.instanceId,t.publish(n))},"federation.bundle":function(n){e.each(n.packingSlip.packingSlips,function(r){t.fedx.onFederatedMsg(e.extend({},n,{packingSlip:r}))})}},p=function(n,r,i){var s=t.fedx.filters[i].hasOwnProperty(n),o=s&&e.any(t.fedx.filters[i][n],function(e){return t.configuration.resolver.compare(e,r)}),u=l.filterMode==="blacklist";return l.enabled&&(u&&(!s||s&&!o)||!u&&s&&o)},d=function(e,t,n){this.transportName=i,this.target=e,this.options=t||{},this.pings={},this.instanceId=n,this.handshakeComplete=!1};return d.prototype.sendPing=function(e){var n=t.fedx.getPackingSlip("ping");this.pings[n.ticket]={ticket:n.ticket,callback:e||NO_OP},this.send(n)},d.prototype.sendPong=function(e){this.send(t.fedx.getPackingSlip("pong",e))},d.prototype.sendBundle=function(e){this.send(t.fedx.getPackingSlip("bundle",e))},d.prototype.sendMessage=function(n){if(!this.handshakeComplete)return;n.originId=n.originId||t.instanceId();var r=e.clone(n);this.instanceId&&this.instanceId!==r.lastSender&&(!r.knownIds||!r.knownIds.length||r.knownIds&&!e.include(r.knownIds,this.instanceId))&&(r.knownIds=(r.knownIds||[]).concat(e.without(e.keys(t.fedx.clients),this.instanceId)),this.send(t.fedx.getPackingSlip("message",r)))},d.prototype.onMessage=function(e){this.shouldProcess()&&t.fedx.onFederatedMsg({transport:this.transportName,packingSlip:e,source:this})},d.prototype.shouldProcess=function(e,t){return!0},d.prototype.send=function(e){throw new Error("An object deriving from FederationClient must provide an implementation for 'send'.")},n(d),t.fedx=e.extend({FederationClient:d,clients:{},transports:{},filters:{"in":{},out:{}},addFilter:function(t){t=e.isArray(t)?t:[t],e.each(t,function(t){t.direction=t.direction||l.filterDirection,e.each(t.direction==="both"?["in","out"]:[t.direction],function(n){this.filters[n][t.channel]?e.include(this.filters[n][t.channel],t.topic)||this.filters[n][t.channel].push(t.topic):this.filters[n][t.channel]=[t.topic]},this)},this)},removeFilter:function(t){t=e.isArray(t)?t:[t],e.each(t,function(t){t.direction=t.direction||l.filterDirection,e.each(t.direction==="both"?["in","out"]:[t.direction],function(n){this.filters[n][t.channel]&&e.include(this.filters[n][t.channel],t.topic)&&(this.filters[n][t.channel]=e.without(this.filters[n][t.channel],t.topic))},this)},this)},canSendRemote:function(e,t){return p(e,t,"out")},configure:function(t){if(t&&t.filterMode&&t.filterMode!=="blacklist"&&t.filterMode!=="whitelist")throw new Error("postal.fedx filterMode must be 'blacklist' or 'whitelist'.");return t&&(l=e.defaults(t,f)),l},getPackingSlip:function(e,t){if(c.hasOwnProperty(e))return c[e].apply(this,Array.prototype.slice.call(arguments,1))},onFederatedMsg:function(e){if(!s){o.push(e);return}if(!h.hasOwnProperty(e.packingSlip.type))throw new Error("postal.federation does not have a message handler for '"+e.packingSlip.type+"'.");h[e.packingSlip.type](e)},sendMessage:function(t){if(!s){u.push(arguments);return}e.each(this.transports,function(e){e.sendMessage(t)})},signalReady:function(t,n){if(!s){a.push(arguments);return}switch(arguments.length){case 0:t=e.reduce(this.transports,function(e,t,n){return e[n]=!0,e},{});break;case 1:typeof t=="function"&&(n=t,t=e.reduce(this.transports,function(e,t,n){return e[n]=!0,e},{}))}Object.prototype.toString.call(t)==="[object String]"?this.transports[t].signalReady([],n):e.each(t||this.transports,function(e,t){e=Object.prototype.toString.call(e)==="[object Boolean]"?[]:e,this.transports[t].signalReady(e,n)},this)}},t.fedx),t.addWireTap(function(e,n){t.fedx.canSendRemote(n.channel,n.topic)&&t.fedx.sendMessage(n)}),t.subscribe({channel:t.configuration.SYSTEM_CHANNEL,topic:"instanceId.changed",callback:function(){s=!0;while(a.length)(function(e){t.fedx.signalReady.apply(this,e)})(a.shift());while(u.length)(function(e){t.fedx.send.apply(this,e)})(u.shift());while(o.length)(function(e){t.fedx.onFederatedMsg.call(this,e)})(o.shift())}}),t.instanceId()!==i&&(s=!0),t})