/*
 postal.federation
 Copyright (C) 2012 - Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT & GPL v2.0
 Version 0.1.0
 */
(function(e,t){typeof module=="object"&&module.exports?module.exports=t(require("underscore"),require("postal")):typeof define=="function"&&define.amd?define(["underscore","postal"],function(n,r){return t(n,r,e)}):e.riveter=t(e._,e.postal,e)})(this,function(e,t,n,r){var i=!0,s=!0;t.fedx=e.extend({_lastOrigin:[],clients:{},transports:{},constraints:{},addClient:function(e){var t=this.clients[e.id];t||(t=this.clients[e.id]={activeTransport:e.type},t.send=function(e,n){n=n||t.activeTransport,t[n].send(e)}),t[e.type]||(t[e.type]={send:e.send},e.postSetup&&e.postSetup())},blacklistMode:function(){s=!0},canSendRemote:function(n,r){var o=this.constraints.hasOwnProperty(n),u=o&&e.any(this.constraints[n],function(e){return t.configuration.resolver.compare(e,r)});return i&&n!==t.configuration.SYSTEM_CHANNEL&&(s&&(!o||o&&!u)||!s&&o&&u)},disable:function(){i=!1},enable:function(){i=!0},getFedxWrapper:function(e){return{postal:!0,type:e,instanceId:t.instanceId}},onFederatedMsg:function(e,n){this._lastOrigin=[n],t.publish(e.envelope),this._lastOrigin=[]},send:function(t){e.each(this.clients,function(n,r){e.include(this._lastOrigin,r)||n.send(t)},this)},signalReady:function(t){t?this.transports[t].signalReady():e.each(this.transports,function(e){e.signalReady()},this)},whitelistMode:function(){s=!1}},t.fedx),t.addWireTap(function(n,r){t.fedx.canSendRemote(r.channel,r.topic)&&(r.originId=r.originId||t.instanceId,t.fedx.send(e.extend({envelope:r},t.fedx.getFedxWrapper("message"))))})})